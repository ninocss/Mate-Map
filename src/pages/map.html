<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mate Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <link rel="stylesheet" href="../styles/root.css">
</head>
<body>
<nav>
    <div class="logo">Mate Maps</div>
    <div class="nav-links">
        <a href="../../index.html">Home</a>
        <a href="./map.html" class="active">Map</a>
        <a href="./about.html">About</a>
    </div>
</nav>

<div class="background-glow"></div>

<section class="map-main">
    <div class="map-shell">
        <div id="map"></div>
        
        <button id="sidebarToggleBtn" class="sidebar-toggle-btn" type="button">
            üîé
        </button>

        <div class="status" id="status">Initializing map‚Ä¶</div>

        <aside class="sidebar">
            <div class="logo"><h2>Mate nearby</h2></div>

            <div class="search-card">
                <div class="form-group">
                    <label for="searchInput">Search location</label>
                    <div class="search-row">
                        <input id="searchInput" type="search" placeholder="City, street, shop‚Ä¶">
                        <button id="locateMeBtn" class="btn-secondary btn-icon" type="button" aria-label="Use current location">
                            üìç
                        </button>
                    </div>
                </div>

                <div class="form-group radius-group">
                    <label for="radiusInput">Search radius</label>
                    <input id="radiusInput" type="range" min="0.5" max="5" step="0.5" value="2">
                    <div class="radius-display">
                        <span id="radiusValue">2.0 km</span>
                    </div>
                </div>

                <div class="search-actions">
                    <button id="searchBtn" class="btn-primary" type="button">Search</button>
                    <button id="applyRadiusBtn" class="btn-secondary" type="button">Apply radius</button>
                </div>
            </div>

            <div class="custom-places-shell">
                <button id="toggleCustomPlacesBtn" class="btn-secondary" type="button">
                    Add / manage custom places
                </button>

                <div class="custom-places-details" id="customPlacesDetails">
                    <div class="form-group">
                        <label for="placeName">Add custom place</label>
                        <input id="placeName" type="text" placeholder="Name of the place">

                        <label for="placeDescription" style="margin-top:0.6rem;">Description</label>
                        <textarea id="placeDescription" rows="3" placeholder="Short note about Mate availability‚Ä¶"></textarea>

                        <label for="placeRating" style="margin-top:0.6rem;">Mate score (1‚Äì5)</label>
                        <select id="placeRating">
                            <option value="">Select rating‚Ä¶</option>
                            <option value="1">1 ‚Äì No mate :c</option>
                            <option value="2">2 ‚Äì Sometimes</option>
                            <option value="3">3 ‚Äì Often available</option>
                            <option value="4">4 ‚Äì Usually has Mate</option>
                            <option value="5">5 ‚Äì Mate heaven</option>
                        </select>
                    </div>

                    <div class="form-group buttons-row">
                        <button id="enableClickAddBtn" class="btn-primary" type="button">
                            Add by clicking map
                        </button>
                        <button id="saveCustomPlaceBtn" class="btn-primary" type="button">
                            Save place
                        </button>
                    </div>
                </div>

                <div class="places-list" id="placesList"></div>
            </div>
        </aside>
    </div>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC8mzOdhZdh52GEQjsj-NB4X9O57ZWCBfw",
        authDomain: "mate-finder-11f42.firebaseapp.com",
        projectId: "mate-finder-11f42",
        storageBucket: "mate-finder-11f42.firebasestorage.app",
        messagingSenderId: "33722154840",
        appId: "1:33722154840:web:519cd93afb5144e2016f2d",
        measurementId: "G-02Y5Z2LYHH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
</script>

<!-- Leaflet JS -->
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
</script>

<script>
    // --- Basic state ---------------------------------------------------------
    let map;
    let userMarker;
    let clickToAddMode = false;
    let clickPreviewMarker = null;
    let pendingCustomLatLng = null;

    const supermarketLayer = L.layerGroup();
    const customPlacesLayer = L.layerGroup();

    const supermarketIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [30, 46],
        iconAnchor: [15, 46],
        popupAnchor: [0, -40],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        shadowSize: [50, 50],
        className: 'marker-supermarket'
    });

    const customPlaceIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [28, 44],
        iconAnchor: [14, 44],
        popupAnchor: [0, -38],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        shadowSize: [46, 46],
        className: 'marker-custom'
    });

    const userLocationIcon = L.divIcon({
        className: 'marker-user-shell',
        html: '<div class="marker-user-dot"></div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
    });

    const places = [];
    const ratingsByPlace = new Map();

    let searchRadiusMeters = 2000; // default 2 km

    // --- DOM references ------------------------------------------------------
    const statusEl = document.getElementById('status');
    const placesListEl = document.getElementById('placesList');

    const placeNameInput = document.getElementById('placeName');
    const placeDescriptionInput = document.getElementById('placeDescription');
    const placeRatingSelect = document.getElementById('placeRating');

    const enableClickAddBtn = document.getElementById('enableClickAddBtn');
    const saveCustomPlaceBtn = document.getElementById('saveCustomPlaceBtn');
    const toggleCustomPlacesBtn = document.getElementById('toggleCustomPlacesBtn');
    const customPlacesDetails = document.getElementById('customPlacesDetails');
    const addPlaceStateEl = document.getElementById('addPlaceState');
    const mapClickTooltip = document.getElementById('mapClickTooltip');

    const radiusInput = document.getElementById('radiusInput');
    const radiusValueEl = document.getElementById('radiusValue');
    const applyRadiusBtn = document.getElementById('applyRadiusBtn');

    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const locateMeBtn = document.getElementById('locateMeBtn');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');

    // --- User id -------------------------------------------------------------
    function getOrCreateUserId() {
        const KEY = 'mateMapsUserId';
        let id = localStorage.getItem(KEY);
        if (!id) {
            id = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
            localStorage.setItem(KEY, id);
        }
        return id;
    }
    const currentUserId = getOrCreateUserId();

    // --- Util ----------------------------------------------------------------
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    function setStatus(message, type = 'info') {
        statusEl.textContent = message;
        statusEl.classList.remove('status-error', 'status-success', 'status-info');
        if (type === 'error') statusEl.classList.add('status-error');
        else if (type === 'success') statusEl.classList.add('status-success');
        else statusEl.classList.add('status-info');
    }

    function starsFromAverage(avg) {
        if (!avg || avg <= 0) return '';
        const rounded = Math.round(avg * 2) / 2;
        const full = Math.floor(rounded);
        const half = rounded % 1 >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;

        let s = '';
        s += '‚òÖ'.repeat(full);
        if (half) s += '‚òÜ';
        s += '‚òÜ'.repeat(empty);
        return s;
    }

    function getPlaceKey(place) {
        if (place.type === 'supermarket') return place.id;
        return place.firestoreId || place.id;
    }

    function buildAddress(tags = {}) {
        const parts = [];
        if (tags['addr:street']) parts.push(tags['addr:street']);
        if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
        const cityParts = [];
        if (tags['addr:postcode']) cityParts.push(tags['addr:postcode']);
        if (tags['addr:city']) cityParts.push(tags['addr:city']);
        if (cityParts.length) parts.push(cityParts.join(' '));
        return parts.join(', ');
    }

    // --- Ratings -------------------------------------------------------------
    async function submitRating(place, score) {
        const placeId = getPlaceKey(place);
        if (!placeId) {
            console.warn('No placeId for rating');
            return;
        }

        const userId = currentUserId;
        const userRatingRef = db
            .collection('ratings')
            .doc(placeId)
            .collection('userRatings')
            .doc(userId);

        try {
            await userRatingRef.set({
                placeId,
                placeType: place.type,
                userId,
                score,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            const snap = await db
                .collection('ratings')
                .doc(placeId)
                .collection('userRatings')
                .get();

            let sum = 0;
            let count = 0;
            snap.forEach(d => {
                const data = d.data();
                const s = Number(data.score);
                if (!Number.isNaN(s)) {
                    sum += s;
                    count += 1;
                }
            });

            if (count > 0) {
                ratingsByPlace.set(placeId, { avg: sum / count, count });
            } else {
                ratingsByPlace.delete(placeId);
            }

            renderPlacesList();

            const updatedPlace = places.find(p => getPlaceKey(p) === placeId);
            if (updatedPlace && updatedPlace.marker && updatedPlace.marker.getPopup()) {
                updatedPlace.marker.setPopupContent(buildPlacePopupHtml(updatedPlace));
            }

            setStatus('Your rating was saved. You can change it, but only one rating per place.', 'success');
        } catch (e) {
            console.error('Error submitting rating', e);
            setStatus('Could not save rating right now. Try again later.', 'error');
        }
    }

    async function preloadRatings() {
        ratingsByPlace.clear();
        try {
            const ratingsRoot = await db.collection('ratings').get();
            const promises = [];

            ratingsRoot.forEach(doc => {
                const placeId = doc.id;
                promises.push(
                    doc.ref.collection('userRatings').get().then(subSnap => {
                        let sum = 0;
                        let count = 0;
                        subSnap.forEach(d => {
                            const data = d.data();
                            const s = Number(data.score);
                            if (!Number.isNaN(s)) {
                                sum += s;
                                count += 1;
                            }
                        });
                        if (count > 0) {
                            ratingsByPlace.set(placeId, { avg: sum / count, count });
                        }
                    })
                );
            });

            await Promise.all(promises);
        } catch (e) {
            console.error('Error loading ratings', e);
        }
    }

    // --- Popup + sidebar rendering ------------------------------------------
    function buildPlacePopupHtml(place) {
        const ratingInfo = ratingsByPlace.get(getPlaceKey(place));
        const avgStars = ratingInfo && ratingInfo.avg ? starsFromAverage(ratingInfo.avg) : '';
        const avgText = ratingInfo && ratingInfo.count
            ? `<div class="popup-rating-line">Average: <span class="popup-stars">${avgStars}</span> (${ratingInfo.count})</div>`
            : '<div class="popup-rating-line">No ratings yet</div>';

        const desc = place.description ? `<div class="popup-desc">${place.description}</div>` : '';
        const addr = place.addr
            ? `<div class="popup-addr">${place.addr}</div>`
            : `<div class="popup-addr">${place.lat.toFixed(5)}, ${place.lon.toFixed(5)}</div>`;

        const starsButtons = Array.from({ length: 5 }, (_, i) => {
            const score = i + 1;
            return `<button class="popup-star-btn" data-score="${score}" data-place-id="${getPlaceKey(place)}">‚òÖ</button>`;
        }).join('');

        return `
            <div class="popup-place">
                <div class="popup-title-row">
                    <b>${place.name}</b>
                    <span class="popup-badge">${place.type === 'supermarket' ? 'Supermarket' : 'Custom'}</span>
                </div>
                ${addr}
                ${desc}
                ${avgText}
                <div class="popup-rate-row">
                    <span>Rate:</span>
                    <div class="popup-stars-row" data-place-id="${getPlaceKey(place)}">
                        ${starsButtons}
                    </div>
                </div>
            </div>
        `;
    }

    function createPlaceSidebarItem(place) {
        const div = document.createElement('div');
        div.className = 'place-item';

        const headerRow = document.createElement('div');
        headerRow.className = 'place-header-row';

        const label = document.createElement('div');
        label.className = 'place-label';
        label.textContent = place.name;

        const typeBadge = document.createElement('span');
        typeBadge.className = 'badge';
        typeBadge.textContent = place.type === 'supermarket' ? 'Supermarket' : 'Custom';
        label.appendChild(typeBadge);

        const ratingInfo = ratingsByPlace.get(getPlaceKey(place));
        if (ratingInfo && ratingInfo.avg) {
            const starsSpan = document.createElement('span');
            starsSpan.className = 'badge badge-stars';
            starsSpan.textContent = starsFromAverage(ratingInfo.avg);
            label.appendChild(starsSpan);
        }

        headerRow.appendChild(label);

        const rateRow = document.createElement('div');
        rateRow.className = 'rate-row';
        rateRow.textContent = 'Rate: ';

        for (let i = 1; i <= 5; i++) {
            const starBtn = document.createElement('button');
            starBtn.type = 'button';
            starBtn.className = 'star-button';
            starBtn.textContent = '‚òÖ';
            starBtn.dataset.score = String(i);
            starBtn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                submitRating(place, i);
            });
            rateRow.appendChild(starBtn);
        }

        const meta = document.createElement('div');
        meta.className = 'place-meta';

        const addrText = place.addr || `${place.lat.toFixed(5)}, ${place.lon.toFixed(5)}`;
        const descText = place.description ? ` ‚Äì ${place.description}` : '';
        meta.textContent = `${addrText}${descText}`;

        div.appendChild(headerRow);
        div.appendChild(meta);
        div.appendChild(rateRow);

         div.addEventListener('click', () => {
            map.setView([place.lat, place.lon], 18);
            place.marker.openPopup();

            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth <= 900 && sidebar) {
                sidebar.classList.add('is-open');
            }
        });


        return div;
    }

    function renderPlacesList() {
        placesListEl.innerHTML = '';
        places.forEach((p) => {
            const el = createPlaceSidebarItem(p);
            placesListEl.appendChild(el);
        });
    }

    // --- Click mode ----------------------------------------------------------
    function resetClickMode() {
        clickToAddMode = false;
        pendingCustomLatLng = null;

        if (clickPreviewMarker) {
            map.removeLayer(clickPreviewMarker);
            clickPreviewMarker = null;
        }
        if (enableClickAddBtn) {
            enableClickAddBtn.textContent = 'Add by clicking map';
            enableClickAddBtn.classList.remove('is-active');
        }
        if (mapClickTooltip) {
            mapClickTooltip.style.display = 'none';
        }
        if (addPlaceStateEl) {
            addPlaceStateEl.textContent = 'Click mode: OFF. Use the button below to drop a marker on the map.';
        }
    }

    function updateClickModeUIOn() {
        if (enableClickAddBtn) {
            enableClickAddBtn.textContent = 'Click on map';
            enableClickAddBtn.classList.add('is-active');
        }
        if (mapClickTooltip) {
            mapClickTooltip.style.display = 'block';
        }
        if (addPlaceStateEl) {
            addPlaceStateEl.textContent = 'Tap anywhere on the map to pick the spot.';
        }
    }

    // --- Custom places -------------------------------------------------------
    async function addCustomPlace(lat, lon) {
        const rawName = placeNameInput.value.trim();
        const rawDescription = placeDescriptionInput.value.trim();
        const ratingValue = placeRatingSelect.value ? parseInt(placeRatingSelect.value, 10) : null;

        const name = rawName || 'Custom place';
        const description = rawDescription || '';
        const rating = ratingValue && ratingValue >= 1 && ratingValue <= 5 ? ratingValue : null;

        let docRef;
        try {
            docRef = await db.collection('customPlaces').add({
                name,
                description,
                rating: rating || null,
                lat,
                lon,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error('Error saving to Firebase', e);
            setStatus('Place added locally, but saving to Firebase failed.', 'error');
        }

        const marker = L.marker([lat, lon], {
            title: name,
            icon: customPlaceIcon
        }).addTo(customPlacesLayer);

        const placeObj = {
            id: docRef ? docRef.id : `custom-${Date.now()}`,
            firestoreId: docRef ? docRef.id : null,
            type: 'custom',
            name,
            description,
            rating,
            addr: '',
            marker,
            lat,
            lon
        };

        marker.bindPopup(buildPlacePopupHtml(placeObj));
        places.push(placeObj);
        renderPlacesList();

        if (rating) {
            const existing = ratingsByPlace.get(placeObj.id);
            if (!existing) {
                ratingsByPlace.set(placeObj.id, { avg: rating, count: 1 });
            }
        }

        if (!rawName) {
            placeNameInput.placeholder = 'You can name the next place here‚Ä¶';
        }

        resetClickMode();
        placeNameInput.value = '';
        placeDescriptionInput.value = '';
        placeRatingSelect.value = '';

        setStatus(`Saved custom place: ${name}`, 'success');
    }

    async function loadCustomPlacesFromFirebase() {
        try {
            const snapshot = await db.collection('customPlaces').get();
            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.lat == null || d.lon == null) return;

                const name = d.name || 'Custom place';
                const description = d.description || '';
                const rating = d.rating || null;

                const marker = L.marker([d.lat, d.lon], {
                    title: name,
                    icon: customPlaceIcon
                }).addTo(customPlacesLayer);

                const placeObj = {
                    id: doc.id,
                    firestoreId: doc.id,
                    type: 'custom',
                    name,
                    description,
                    rating,
                    addr: '',
                    marker,
                    lat: d.lat,
                    lon: d.lon
                };

                marker.bindPopup(buildPlacePopupHtml(placeObj));
                places.push(placeObj);
            });
        } catch (e) {
            console.error('Error loading custom places from Firebase', e);
        }
    }

    // --- Map + supermarkets --------------------------------------------------
    function initMap(lat, lon, zoom = 15) {
        map = L.map('map').setView([lat, lon], zoom);

        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            attribution: '&copy; OpenStreetMap, CartoDB'
        }).addTo(map);;

        userMarker = L.marker([lat, lon], {
            title: 'Your position',
            icon: userLocationIcon
        }).addTo(map).bindPopup('Search center');

        supermarketLayer.addTo(map);
        customPlacesLayer.addTo(map);

        map.on('click', (e) => {
            if (!clickToAddMode) return;

            pendingCustomLatLng = e.latlng;

            if (!clickPreviewMarker) {
                clickPreviewMarker = L.marker(e.latlng, {
                    title: 'New place position',
                    opacity: 0.9,
                    icon: L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                        shadowSize: [41, 41],
                        className: 'map-click-preview'
                    })
                }).addTo(map);
            } else {
                clickPreviewMarker.setLatLng(e.latlng);
            }

            setStatus(
                `Selected point: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}. Now fill the form and click ‚ÄúSave place‚Äù.`,
                'info'
            );
        });
    }

    async function loadSupermarkets(lat, lon) {
        statusEl.textContent = 'Loading supermarkets around you‚Ä¶';

        const radiusMeters = searchRadiusMeters;
        const query = `
            [out:json][timeout:25];
            (
            node["shop"="supermarket"](around:${radiusMeters},${lat},${lon});
            way["shop"="supermarket"](around:${radiusMeters},${lat},${lon});
            relation["shop"="supermarket"](around:${radiusMeters},${lat},${lon});
            );
            out center;
        `;

        try {
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });

            if (!response.ok) {
                throw new Error('Overpass API error: ' + response.status);
            }

            const data = await response.json();
            supermarketLayer.clearLayers();
            places.length = 0;
            placesListEl.innerHTML = '';

            if (!data.elements || data.elements.length === 0) {
                statusEl.textContent = 'No supermarkets found nearby (within ~2 km).';
                return;
            }

            statusEl.textContent = `Found ${data.elements.length} supermarkets.`;

            data.elements.forEach((el) => {
                const plat = el.lat || (el.center && el.center.lat);
                const plon = el.lon || (el.center && el.center.lon);
                if (plat == null || plon == null) return;

                const osmId = `${el.type || 'el'}:${el.id}`;
                const name = (el.tags && (el.tags.name || el.tags.brand)) || 'Unnamed supermarket';
                const addr = buildAddress(el.tags);

                const marker = L.marker([plat, plon], {
                    title: name,
                    icon: supermarketIcon
                }).addTo(supermarketLayer);

                const placeObj = {
                    id: osmId,
                    type: 'supermarket',
                    name,
                    addr,
                    marker,
                    lat: plat,
                    lon: plon
                };

                marker.bindPopup(buildPlacePopupHtml(placeObj));
                places.push(placeObj);
            });

            renderPlacesList();
        } catch (err) {
            console.error(err);
            statusEl.textContent = 'Failed to load supermarkets (Overpass API). Try again later.';
        }
    }

    // --- Geocoding + bootstrap ----------------------------------------------
    async function geocodeQuery(query) {
        statusEl.textContent = `Searching for "${query}"‚Ä¶`;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;

        try {
            const res = await fetch(url, {
                headers: { 'Accept-Language': 'en' }
            });
            if (!res.ok) throw new Error('Geocoding failed: ' + res.status);
            const data = await res.json();
            if (!data.length) {
                statusEl.textContent = `Could not find location for "${query}". Falling back to your GPS location.`;
                return null;
            }
            const { lat, lon, display_name } = data[0];
            statusEl.textContent = `Showing results for: ${display_name}`;
            return {
                lat: parseFloat(lat),
                lon: parseFloat(lon),
                label: display_name
            };
        } catch (e) {
            console.error(e);
            statusEl.textContent = 'Geocoding failed. Falling back to your GPS location.';
            return null;
        }
    }
    
    function wireInputFocusHelpers() {
        const focusables = [searchInput, placeNameInput, placeDescriptionInput, placeRatingSelect]
            .filter(Boolean);

        focusables.forEach(el => {
            el.addEventListener('focus', () => {
                document.body.classList.add('input-focused');
            });
            el.addEventListener('blur', () => {
                document.body.classList.remove('input-focused');
            });
        });
    }

    async function bootstrap() {
        await preloadRatings();
        wireInputFocusHelpers();

        const params = new URLSearchParams(window.location.search);
        const latParam = params.get('lat');
        const lonParam = params.get('lon');
        const zParam = params.get('z');
        const query = getQueryParam('q');

        if (latParam && lonParam) {
            const lat = parseFloat(latParam);
            const lon = parseFloat(lonParam);
            const zoom = zParam ? parseInt(zParam, 10) || 14 : 14;
            initMap(lat, lon, zoom);
            await loadCustomPlacesFromFirebase();
            await loadSupermarkets(lat, lon);
            statusEl.textContent = 'Opened view.';
            return;
        }

        if (query) {
            const geo = await geocodeQuery(query);
            if (geo) {
                initMap(geo.lat, geo.lon, 14);
                await loadCustomPlacesFromFirebase();
                await loadSupermarkets(geo.lat, geo.lon);
                userMarker.bindPopup(`Search center: ${geo.label || query}`);
                return;
            }
        }

        if (!navigator.geolocation) {
            statusEl.textContent = 'Geolocation not available. Centering map on Berlin.';
            const fallbackLat = 52.52;
            const fallbackLon = 13.405;
            initMap(fallbackLat, fallbackLon, 13);
            await loadCustomPlacesFromFirebase();
            await loadSupermarkets(fallbackLat, fallbackLon);
            return;
        }

        statusEl.textContent = 'Requesting your location‚Ä¶';

        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                const { latitude, longitude } = pos.coords;
                initMap(latitude, longitude, 15);
                await loadCustomPlacesFromFirebase();
                statusEl.textContent = 'Location acquired. Loading supermarkets‚Ä¶';
                await loadSupermarkets(latitude, longitude);
            },
            async (err) => {
                console.warn('Geolocation error', err);
                statusEl.textContent = 'Could not get your location (permission denied?). Centering map on Berlin.';
                const fallbackLat = 52.52;
                const fallbackLon = 13.405;
                initMap(fallbackLat, fallbackLon, 13);
                await loadCustomPlacesFromFirebase();
                await loadSupermarkets(fallbackLat, fallbackLon);
            },
            {
                enableHighAccuracy: true,
                timeout: 8000,
                maximumAge: 0
            }
        );

        // UI wiring
        toggleCustomPlacesBtn.addEventListener('click', () => {
            const isOpen = customPlacesDetails.classList.toggle('is-open');
            toggleCustomPlacesBtn.textContent = isOpen
                ? 'Hide custom place form'
                : 'Add / manage custom places';

            if (!isOpen) {
                resetClickMode();
            }
        });

        enableClickAddBtn.addEventListener('click', () => {
            if (!clickToAddMode) {
                clickToAddMode = true;
                pendingCustomLatLng = null;

                if (clickPreviewMarker) {
                    map.removeLayer(clickPreviewMarker);
                    clickPreviewMarker = null;
                }

                updateClickModeUIOn();
                setStatus(
                    'Click anywhere on the map to choose a position for your new place, then fill the form and press ‚ÄúSave place‚Äù.',
                    'info'
                );
            } else {
                resetClickMode();
                setStatus('Click mode disabled.', 'info');
            }
        });

        saveCustomPlaceBtn.addEventListener('click', async () => {
            if (!pendingCustomLatLng) {
                setStatus('Click on the map first to choose where the custom place is.', 'error');
                return;
            }

            const ratingValue = placeRatingSelect.value ? parseInt(placeRatingSelect.value, 10) : null;
            if (ratingValue !== null && (ratingValue < 1 || ratingValue > 5)) {
                setStatus('Mate score must be between 1 and 5.', 'error');
                return;
            }

            await addCustomPlace(pendingCustomLatLng.lat, pendingCustomLatLng.lng);
        });

        if (radiusInput && radiusValueEl) {
            const updateRadiusLabel = () => {
                const km = parseFloat(radiusInput.value || '2');
                radiusValueEl.textContent = `${km.toFixed(1)} km`;
            };
            radiusInput.addEventListener('input', updateRadiusLabel);
            updateRadiusLabel();
        }

        applyRadiusBtn?.addEventListener('click', async () => {
            const km = parseFloat(radiusInput.value || '2');
            searchRadiusMeters = Math.max(0.1, km) * 1000;
            if (map) {
                const center = map.getCenter();
                await loadSupermarkets(center.lat, center.lng);
                setStatus(`Updated radius to ${km.toFixed(1)} km and reloaded supermarkets.`, 'info');
            }
        });

        searchBtn?.addEventListener('click', async () => {
            const q = (searchInput?.value || '').trim();
            if (!q) {
                setStatus('Enter a location to search.', 'error');
                return;
            }
            const geo = await geocodeQuery(q);
            if (!geo) return;

            map.setView([geo.lat, geo.lon], 14);
            userMarker.setLatLng([geo.lat, geo.lon]);
            userMarker.bindPopup(`Search center: ${geo.label || q}`);
            await loadSupermarkets(geo.lat, geo.lon);
        });

        searchInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchBtn?.click();
            }
        });

        locateMeBtn?.addEventListener('click', () => {
            if (!navigator.geolocation) {
                setStatus('Geolocation not available on this device.', 'error');
                return;
            }
            setStatus('Locating you‚Ä¶', 'info');
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    if (!map) {
                        initMap(latitude, longitude, 15);
                        await loadCustomPlacesFromFirebase();
                    } else {
                        map.setView([latitude, longitude], 15);
                        userMarker.setLatLng([latitude, longitude]);
                        userMarker.bindPopup('Your location');
                    }
                    await loadSupermarkets(latitude, longitude);
                    setStatus('Centered on your location.', 'success');
                },
                (err) => {
                    console.warn('Locate me error', err);
                    setStatus('Could not get your location.', 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                }
            );
        });

        // Sidebar toggle (mobile)
        sidebarToggleBtn?.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;
            const isOpen = sidebar.classList.toggle('is-open');
        });
    }

    // --- Popup rating click delegation --------------------------------------
    if (typeof L !== 'undefined') {
        document.addEventListener('click', (ev) => {
            const target = ev.target;
            if (!(target instanceof HTMLElement)) return;
            if (!target.classList.contains('popup-star-btn')) return;

            ev.stopPropagation();
            const score = parseInt(target.getAttribute('data-score') || '0', 10);
            const placeId = target.getAttribute('data-place-id');
            if (!score || !placeId) return;

            const place = places.find(p => getPlaceKey(p) === placeId);
            if (!place) return;

            submitRating(place, score);
        });
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>